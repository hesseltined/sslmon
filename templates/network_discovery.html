<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Network Discovery â€“ SSLMon</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">SSLMon</a>
    <div class="d-flex">
      <a class="btn btn-sm btn-outline-light me-2" href="/">Dashboard</a>
      <a class="btn btn-sm btn-outline-light me-2" href="/domains">Manage Domains</a>
      <a class="btn btn-sm btn-outline-light me-2" href="/overview">Overview</a>
      <a class="btn btn-sm btn-outline-light me-2" href="/admin">Admin</a>
      <a class="btn btn-sm btn-outline-light" href="/logout">Logout</a>
    </div>
  </div>
</nav>

<div class="container my-4">
<h3>Network Discovery</h3>
<p class="text-muted">Automatically discover SSL-enabled hosts on your network</p>

{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if scanning %}
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Scanning {{ scan_count }} Hosts</h5>
    <div class="progress" style="height: 30px;">
      <div id="scan-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
           role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        0%
      </div>
    </div>
    <div class="mt-2 text-muted small" id="scan-status">
      Initializing scan...
    </div>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Auto-Detect Local Networks</h5>
        <p class="card-text">Automatically scan networks this server is connected to.</p>
        <form method="post" action="/network-discovery/auto">
          <button type="submit" class="btn btn-primary">Scan Local Networks</button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Manual IP Range</h5>
        <p class="card-text">Scan specific IP ranges for SSL certificates.</p>
        <form method="post" action="/network-discovery/manual">
          <div class="mb-3">
            <input type="text" class="form-control" name="ip_range" 
                   placeholder="192.168.1.0/24 or 10.0.0.1-10.0.0.254" required>
            <div class="form-text">Enter CIDR notation or IP range</div>
          </div>
          <button type="submit" class="btn btn-primary">Scan Range</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">DNS Zone Query</h5>
    <p class="card-text">Query DNS server to discover hosts in domain zones.</p>
    <form method="post" action="/network-discovery/dns">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">DNS Server</label>
          <input type="text" class="form-control" name="dns_server" 
                 placeholder="10.0.0.1 or dns.company.local" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Domain/Zone</label>
          <input type="text" class="form-control" name="domain_zone" 
                 placeholder="company.local" required>
        </div>
      </div>
      <button type="submit" class="btn btn-primary mt-3">Query DNS Zone</button>
    </form>
  </div>
</div>

{% if discovered %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title">Discovered Hosts ({{ discovered|length }})</h5>
    
    {% if discovered %}
    <form method="post" action="/network-discovery/add-selected">
      <table class="table table-sm">
        <thead>
          <tr>
            <th style="width:50px">
              <input type="checkbox" id="select-all" onclick="toggleAll(this)">
            </th>
            <th>Host</th>
            <th>IP Address</th>
            <th>Issuer</th>
            <th>Expires</th>
            <th>Days</th>
          </tr>
        </thead>
        <tbody>
          {% for host in discovered %}
          <tr>
            <td>
              <input type="checkbox" name="selected_hosts" value="{{ host.domain }}" class="host-checkbox">
            </td>
            <td>{{ host.domain }}</td>
            <td>{{ host.ip }}</td>
            <td>{{ host.issuer or 'Unknown' }}</td>
            <td>{{ host.expires or 'N/A' }}</td>
            <td>
              {% if host.days_remaining %}
                <span class="{% if host.days_remaining <= 14 %}text-danger{% elif host.days_remaining <= 30 %}text-warning{% else %}text-success{% endif %}">
                  {{ host.days_remaining }}
                </span>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      
      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-success">Add Selected to Monitoring</button>
        <button type="submit" name="add_all" value="1" class="btn btn-primary">Add All</button>
      </div>
    </form>
    {% endif %}
  </div>
</div>
{% endif %}

<div class="alert alert-warning mt-4" role="alert">
  <strong>Note:</strong> Network scanning performs SSL handshakes on port 443. 
  This is normal HTTPS traffic and should not trigger security alerts. 
  Scanning is performed slowly (5 hosts/second) to be network-friendly.
</div>

<p class="mt-4">
  <a href="/domains" class="btn btn-secondary">Back to Domains</a>
</p>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function toggleAll(source) {
  const checkboxes = document.getElementsByClassName('host-checkbox');
  for (let i = 0; i < checkboxes.length; i++) {
    checkboxes[i].checked = source.checked;
  }
}

{% if scanning %}
// Connect to SSE endpoint for real-time progress
const eventSource = new EventSource('/network-discovery/scan-progress');

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  
  if (data.error) {
    document.getElementById('scan-status').innerHTML = '<span class="text-danger">Error: ' + data.error + '</span>';
    eventSource.close();
    return;
  }
  
  if (data.complete) {
    // Scan complete - reload page to show results
    eventSource.close();
    window.location.reload();
  } else {
    // Update progress bar
    const progressBar = document.getElementById('scan-progress-bar');
    const statusText = document.getElementById('scan-status');
    
    progressBar.style.width = data.percent + '%';
    progressBar.setAttribute('aria-valuenow', data.percent);
    progressBar.textContent = data.percent + '%';
    
    statusText.textContent = `Scanned ${data.current} of ${data.total} hosts - Found ${data.discovered_count} with SSL`;
  }
};

eventSource.onerror = function(event) {
  console.error('SSE error:', event);
  document.getElementById('scan-status').innerHTML = '<span class="text-danger">Connection error. Refreshing...</span>';
  eventSource.close();
  setTimeout(() => window.location.reload(), 2000);
};
{% endif %}
</script>
</body>
</html>
