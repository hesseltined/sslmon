<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SMTP Configuration â€“ SSLMon</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">SSLMon</a>
    <div class="d-flex">
      <a class="btn btn-sm btn-outline-light me-2" href="/">Dashboard</a>
      <a class="btn btn-sm btn-outline-light me-2" href="/domains">Manage Domains</a>
      <a class="btn btn-sm btn-outline-light me-2" href="/overview">Overview</a>
      <a class="btn btn-sm btn-outline-light me-2" href="/admin">Admin</a>
      <a class="btn btn-sm btn-outline-light" href="/logout">Logout</a>
    </div>
  </div>
</nav>

<div class="container my-4">
<h3>SMTP Configuration</h3>
<p class="text-muted">Configure email notifications for certificate expiration alerts</p>

{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Quick Setup Presets</label>
      <div class="btn-group w-100" role="group">
        <button type="button" class="btn btn-outline-secondary" onclick="setO365()">Office 365 / Microsoft 365</button>
        <button type="button" class="btn btn-outline-secondary" onclick="setGmail()">Gmail</button>
        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">Custom</button>
      </div>
      <div class="form-text">Select a preset or use custom settings</div>
    </div>

    <form method="post">
      <div class="mb-3">
        <label for="smtp_host" class="form-label">SMTP Server</label>
        <input type="text" class="form-control" id="smtp_host" name="smtp_host" 
               value="{{ config.smtp_host or '' }}" 
               placeholder="smtp.office365.com" required>
        <div class="form-text">Your mail server hostname</div>
      </div>

      <div class="mb-3">
        <label for="smtp_port" class="form-label">SMTP Port</label>
        <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
               value="{{ config.smtp_port or 587 }}" required>
        <div class="form-text">Usually 587 (STARTTLS) or 465 (SSL)</div>
      </div>

      <div class="mb-3">
        <label for="smtp_user" class="form-label">SMTP Username</label>
        <input type="text" class="form-control" id="smtp_user" name="smtp_user" 
               value="{{ config.smtp_user or '' }}" 
               placeholder="alerts@example.com" required>
        <div class="form-text">Email address to send from</div>
      </div>

      <div class="mb-3">
        <label for="smtp_pass" class="form-label">SMTP Password</label>
        <input type="password" class="form-control" id="smtp_pass" name="smtp_pass" 
               placeholder="Leave blank to keep existing password">
        <div class="form-text">Password will be encrypted and stored securely</div>
      </div>

      <div class="mb-3">
        <label for="to_emails" class="form-label">Alert Recipients</label>
        <input type="text" class="form-control" id="to_emails" name="to_emails" 
               value="{{ config.to_emails|join(', ') if config.to_emails else '' }}" 
               placeholder="admin@example.com, msp@example.com" required>
        <div class="form-text">Comma-separated list of email addresses (client and MSP)</div>
      </div>

      <hr class="my-4">
      <h5>Alert Configuration</h5>
      <div class="alert alert-info" role="alert">
        <strong>Current Alert Thresholds:</strong><br>
        Warning: {{ config.alert_threshold_warning or 30 }} days | 
        Critical: {{ config.alert_threshold_critical or 14 }} days | 
        Frequency: {{ config.alert_frequency or 'once' | title }}
        {% if config.monthly_report %} | Monthly Reports: Enabled{% endif %}
      </div>
      
      <div class="mb-3">
        <label for="alert_threshold_warning" class="form-label">Warning Threshold (days)</label>
        <input type="number" class="form-control" id="alert_threshold_warning" name="alert_threshold_warning" 
               value="{{ config.alert_threshold_warning or 30 }}" min="1" required>
        <div class="form-text">Send warning when certificates expire within this many days</div>
      </div>

      <div class="mb-3">
        <label for="alert_threshold_critical" class="form-label">Critical Threshold (days)</label>
        <input type="number" class="form-control" id="alert_threshold_critical" name="alert_threshold_critical" 
               value="{{ config.alert_threshold_critical or 14 }}" min="1" required>
        <div class="form-text">Send critical alert when certificates expire within this many days</div>
      </div>

      <div class="mb-3">
        <label for="alert_frequency" class="form-label">Alert Frequency</label>
        <select class="form-select" id="alert_frequency" name="alert_frequency" required>
          <option value="daily" {% if config.alert_frequency == 'daily' %}selected{% endif %}>Daily (once per day)</option>
          <option value="every_check" {% if config.alert_frequency == 'every_check' %}selected{% endif %}>Every Check (24 hours)</option>
          <option value="weekly" {% if config.alert_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
          <option value="once" {% if config.alert_frequency == 'once' or not config.alert_frequency %}selected{% endif %}>Once Only (until resolved)</option>
        </select>
        <div class="form-text">How often to send alerts for the same certificate</div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="monthly_report" name="monthly_report" 
                 {% if config.monthly_report %}checked{% endif %}>
          <label class="form-check-label" for="monthly_report">
            Send monthly status report
          </label>
          <div class="form-text">Receive a full certificate status report every month (1st of month)</div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Save Configuration</button>
    </form>
  </div>
</div>

<script>
function setO365() {
  document.getElementById('smtp_host').value = 'smtp.office365.com';
  document.getElementById('smtp_port').value = '587';
  alert('Office 365 settings applied. Enter your email address as username.');
}

function setGmail() {
  document.getElementById('smtp_host').value = 'smtp.gmail.com';
  document.getElementById('smtp_port').value = '587';
  alert('Gmail settings applied. You may need to create an App Password.');
}

function clearForm() {
  document.getElementById('smtp_host').value = '';
  document.getElementById('smtp_port').value = '587';
  document.getElementById('smtp_host').focus();
}
</script>

{% if config.smtp_host %}
<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Test Email Configuration</h5>
    <p class="card-text">Send test emails to verify your SMTP settings and alert templates.</p>
    <div class="btn-group" role="group">
      <form method="post" action="/admin/smtp/test" class="d-inline me-2">
        <button type="submit" class="btn btn-success">Send Test Email</button>
      </form>
      <form method="post" action="/admin/smtp/test-warning" class="d-inline me-2">
        <button type="submit" class="btn btn-warning">Test Warning Alert</button>
      </form>
      <form method="post" action="/admin/smtp/test-critical" class="d-inline">
        <button type="submit" class="btn btn-danger">Test Critical Alert</button>
      </form>
    </div>
    <div class="form-text mt-2">Test emails will use example.com with simulated expiry dates</div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Current Configuration</h5>
    <table class="table table-sm">
      <tr>
        <th>SMTP Server:</th>
        <td>{{ config.smtp_host }}</td>
      </tr>
      <tr>
        <th>Port:</th>
        <td>{{ config.smtp_port }}</td>
      </tr>
      <tr>
        <th>Username:</th>
        <td>{{ config.smtp_user }}</td>
      </tr>
      <tr>
        <th>Password:</th>
        <td>{{ config.smtp_pass }}</td>
      </tr>
      <tr>
        <th>Recipients:</th>
        <td>{{ config.to_emails|join(', ') if config.to_emails else 'None' }}</td>
      </tr>
    </table>
  </div>
</div>
{% endif %}

<p class="mt-4">
  <a href="/admin" class="btn btn-secondary">Back to Admin</a>
</p>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
